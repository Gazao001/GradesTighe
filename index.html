<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Notes - Sismondi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #2d3748;
            min-height: 100vh;
            padding: 10px;
            color: #333;
            font-size: 18px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 12px;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .add-grade-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 16px 40px;
            border-radius: 25px;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .add-grade-btn:active {
            transform: scale(0.98);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .subject-row {
            background: white;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .subject-row:active {
            transform: scale(0.99);
            background: #f9fafb;
        }

        .subject-name {
            font-weight: 700;
            font-size: 20px;
            color: #1f2937;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 2px solid #e5e7eb;
        }

        .semesters-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .semester-row {
            display: grid;
            grid-template-columns: 25px 1fr auto;
            align-items: center;
            gap: 10px;
        }

        .semester-label {
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
        }

        .grades-line {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }

        .semestriel-cell {
            min-width: 120px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }

        .grade-badge {
            background: #e5e7eb;
            color: #1f2937;
            padding: 8px 14px;
            border-radius: 12px;
            font-size: 20px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            border: 2px solid #9ca3af;
        }

        /* Color coding based on grade value */
        .grade-badge.grade-excellent {
            background: #d1fae5;
            color: #065f46;
            border-color: #10b981;
        }

        .grade-badge.grade-good {
            background: #dbeafe;
            color: #1e40af;
            border-color: #3b82f6;
        }

        .grade-badge.grade-sufficient {
            background: #fef3c7;
            color: #92400e;
            border-color: #f59e0b;
        }

        .grade-badge.grade-insufficient {
            background: #fee2e2;
            color: #991b1b;
            border-color: #ef4444;
        }

        .grade-weight {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #ffffff;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
        }

        .grade-weight.double {
            background: #fef3c7;
            color: #92400e;
            border-color: #f59e0b;
        }

        .grade-delete {
            color: #ef4444;
            font-weight: bold;
            cursor: pointer;
            font-size: 22px;
            line-height: 1;
        }

        .semestriel-badge {
            background: #fef3c7;
            color: #92400e;
            padding: 10px 16px;
            border-radius: 12px;
            font-size: 20px;
            font-weight: 700;
            border: 2px solid #f59e0b;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .semestriel-empty {
            color: #9ca3af;
            font-size: 18px;
            font-style: italic;
        }

        .empty-grades {
            color: #9ca3af;
            font-size: 18px;
            font-style: italic;
        }

        .divider {
            width: 3px;
            height: 30px;
            background: #d1d5db;
            border-radius: 2px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 20px;
            max-width: 400px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 18px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-label {
            display: block;
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-select, .form-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 20px;
            background: white;
        }

        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 28px;
            height: 28px;
            cursor: pointer;
        }

        .checkbox-group label {
            cursor: pointer;
            user-select: none;
            font-size: 18px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        /* Tabs */
        .tab-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .tab-btn {
            flex: 1;
            padding: 14px;
            background: rgba(255, 255, 255, 0.3);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: white;
            color: #667eea;
        }

        .tab-btn:active {
            transform: scale(0.98);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Projections */
        .metrics-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .metric-item {
            background: #f7f9fc;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-label {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 26px;
            font-weight: 700;
        }

        .metric-value.good { color: #10b981; }
        .metric-value.warning { color: #f59e0b; }
        .metric-value.danger { color: #ef4444; }

        .slider-row {
            background: white;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .slider-subject {
            font-weight: 700;
            font-size: 18px;
            color: #1f2937;
        }

        .slider-value {
            font-size: 24px;
            font-weight: 700;
            padding: 5px 12px;
            border-radius: 8px;
        }

        .slider-container {
            position: relative;
            height: 40px;
            background: #e5e7eb;
            border-radius: 20px;
            overflow: hidden;
        }

        .slider-fill {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            transition: all 0.2s;
            border-radius: 20px;
        }

        .slider-fill.warning {
            background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
        }

        .slider-fill.danger {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
        }

        .slider-input {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 10;
        }

        .slider-target-line {
            position: absolute;
            left: 60%;
            width: 3px;
            background: #1f2937;
            z-index: 5;
        }

        .slider-target-line-top {
            top: 0;
            height: calc(50% - 12px);
        }

        .slider-target-line-bottom {
            bottom: 0;
            height: calc(50% - 12px);
        }

        .slider-current-marker {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            background: white;
            border: 3px solid #667eea;
            border-radius: 50%;
            z-index: 6;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .slider-markers {
            position: absolute;
            width: 100%;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            justify-content: space-between;
            padding: 0 10px;
            z-index: 1;
            pointer-events: none;
        }

        .slider-marker {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
        }

        .slider-middle-marker {
            position: absolute;
            left: 60%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 11px;
            color: #1f2937;
            font-weight: 700;
            background: white;
            padding: 2px 6px;
            border-radius: 4px;
            z-index: 7;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .status-banner {
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .status-banner.pass {
            background: #d1fae5;
            color: #065f46;
        }

        .status-banner.tolerance {
            background: #fef3c7;
            color: #92400e;
        }

        .status-banner.fail {
            background: #dc2626;
            color: #ffffff;
        }

        @media (max-width: 600px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Mes Notes</h1>
        </div>

        <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchTab('grades')">Mes Notes</button>
            <button class="tab-btn" onclick="switchTab('projections')">Projections</button>
            <button class="tab-btn" onclick="switchTab('rules')">R√®gles</button>
        </div>

        <!-- Grades Tab -->
        <div id="gradesTab" class="tab-content active">
            <button class="add-grade-btn" onclick="openAddGradeModal()" style="width: 100%; margin-bottom: 15px;">+ Ajouter une Note</button>
            <div id="gradesContainer"></div>
        </div>

        <!-- Projections Tab -->
        <div id="projectionsTab" class="tab-content">
            <div id="statusBanner" class="status-banner"></div>

            <div class="metrics-card">
                <div style="font-size: 20px; font-weight: 700; margin-bottom: 12px; color: #1f2937;">Situation</div>
                <div class="metrics-grid">
                    <div class="metric-item">
                        <div class="metric-label">Moyenne (‚â•4.0)</div>
                        <div class="metric-value" id="projAvg">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Option Sp√©. (‚â•4.0)</div>
                        <div class="metric-value" id="projOS">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Total Critique (‚â•16.0)</div>
                        <div class="metric-value" id="projCrit">-</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Insuffisances (‚â§3, ‚â§1.0)</div>
                        <div class="metric-value" id="projInsuff">-</div>
                    </div>
                </div>
            </div>

            <div style="background: white; border-radius: 12px; padding: 12px; margin-bottom: 12px;">
                <div style="font-size: 16px; font-weight: 700; color: #1f2937;">
                    Simule tes futures moyennes
                </div>
            </div>

            <div id="slidersContainer"></div>
        </div>

        <!-- Rules Tab -->
        <div id="rulesTab" class="tab-content">
            <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 12px;">
                <h2 style="font-size: 24px; font-weight: 700; color: #1f2937; margin-bottom: 16px;">Les R√®gles de Promotion</h2>

                <h3 style="font-size: 20px; font-weight: 700; color: #1f2937; margin-top: 24px; margin-bottom: 12px;">1. Calcul de la Moyenne Annuelle</h3>
                <p style="margin-bottom: 12px; line-height: 1.6;">La moyenne annuelle de chaque branche est calcul√©e selon le poids des notes r√©guli√®res et des examens semestriels :</p>
                <ul style="margin-left: 20px; margin-bottom: 16px; line-height: 1.8;">
                    <li><strong>Notes avec coefficient simple (√ó1) :</strong> Comptent pour leur valeur</li>
                    <li><strong>Notes avec coefficient double (√ó2) :</strong> Comptent deux fois</li>
                    <li><strong>Examens semestriels :</strong> Ont un poids sp√©cifique selon la branche</li>
                </ul>

                <div style="background: #f3f4f6; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                    <strong>Exemple :</strong> En Math (50% r√©gulier / 50% semestriel)<br>
                    Notes r√©guli√®res : 4.0 (√ó1), 5.0 (√ó2), 3.0 (√ó1)<br>
                    Moyenne r√©guli√®re = (4.0 + 5.0 + 5.0 + 3.0) / 4 = 4.25 ‚âà 4.5<br>
                    Semestriel : 4.5<br>
                    <strong>Moyenne finale = (4.5 √ó 0.5) + (4.5 √ó 0.5) = 4.5</strong>
                </div>

                <h3 style="font-size: 20px; font-weight: 700; color: #1f2937; margin-top: 24px; margin-bottom: 12px;">2. Conditions de Promotion Directe</h3>
                <p style="margin-bottom: 12px; line-height: 1.6;">Pour √™tre promu directement, l'√©l√®ve doit avoir :</p>
                <ul style="margin-left: 20px; margin-bottom: 16px; line-height: 1.8;">
                    <li><strong>Moyenne g√©n√©rale ‚â• 4.0</strong></li>
                    <li><strong>Aucune insuffisance</strong> (toutes les branches ‚â• 4.0)</li>
                </ul>

                <h3 style="font-size: 20px; font-weight: 700; color: #1f2937; margin-top: 24px; margin-bottom: 12px;">3. Conditions de Promotion par Tol√©rance</h3>
                <p style="margin-bottom: 12px; line-height: 1.6;">Si l'√©l√®ve a des insuffisances, il peut √™tre promu par tol√©rance si <strong>TOUTES</strong> les conditions suivantes sont remplies :</p>
                <ul style="margin-left: 20px; margin-bottom: 16px; line-height: 1.8;">
                    <li><strong>Moyenne g√©n√©rale ‚â• 4.0</strong></li>
                    <li><strong>Option sp√©cifique ‚â• 4.0</strong> (moyenne de √âconomie et Droit)</li>
                    <li><strong>Maximum 3 insuffisances</strong> (branches < 4.0)</li>
                    <li><strong>D√©ficit total ‚â§ 1.0 point</strong> (somme des √©carts √† 4.0)</li>
                    <li><strong>Total critique ‚â• 16.0</strong> (Fran√ßais + Moyenne des langues + Math + Option sp√©cifique)</li>
                </ul>

                <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #f59e0b;">
                    <strong>Exemple de tol√©rance :</strong><br>
                    Branches insuffisantes : Allemand 3.5, Chimie 3.5, Math 3.5<br>
                    Nombre d'insuffisances : 3 ‚úì<br>
                    D√©ficit total : (4.0-3.5) + (4.0-3.5) + (4.0-3.5) = 1.5 ‚úó<br>
                    <strong>R√©sultat : Non promu (d√©ficit trop √©lev√©)</strong>
                </div>

                <h3 style="font-size: 20px; font-weight: 700; color: #1f2937; margin-top: 24px; margin-bottom: 12px;">4. Calcul du Total Critique</h3>
                <p style="margin-bottom: 12px; line-height: 1.6;">Le total critique se calcule ainsi :</p>
                <div style="background: #eff6ff; padding: 12px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #3b82f6;">
                    <strong>Total Critique = Fran√ßais + ((Allemand + Anglais) / 2) + Math + ((√âconomie + Droit) / 2)</strong>
                </div>
                <p style="margin-bottom: 12px; line-height: 1.6;">Ce total doit √™tre au minimum <strong>16.0 points</strong> pour la promotion par tol√©rance.</p>

                <h3 style="font-size: 20px; font-weight: 700; color: #1f2937; margin-top: 24px; margin-bottom: 12px;">5. Pond√©ration par Branche</h3>
                <p style="margin-bottom: 12px; line-height: 1.6;">Chaque branche a sa propre pond√©ration entre notes r√©guli√®res et semestriels :</p>
                <ul style="margin-left: 20px; margin-bottom: 16px; line-height: 1.8; font-size: 16px;">
                    <li><strong>50% r√©gulier / 50% semestriel :</strong> Math, Fran√ßais, Histoire, G√©ographie, √âconomie, Droit, Chimie, Art, Gym, Informatique, Histoire de l'Art</li>
                    <li><strong>60% r√©gulier / 40% semestriel :</strong> Physique</li>
                    <li><strong>67% r√©gulier / 33% semestriel :</strong> Allemand, Anglais, Biologie</li>
                </ul>

                <div style="background: #fee2e2; padding: 12px; border-radius: 8px; margin-top: 24px; border-left: 4px solid #dc2626;">
                    <strong>Important :</strong> Ces r√®gles sont indicatives. Seule la d√©cision officielle du conseil de classe fait foi.
                </div>
            </div>
        </div>
    </div>

    <!-- Add Grade Modal -->
    <div id="addGradeModal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">Ajouter une Note</div>

            <div class="form-group">
                <label class="form-label">Mati√®re</label>
                <select class="form-select" id="subjectSelect">
                    <option value="">-- Choisir --</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Note (1.0 - 6.0)</label>
                <input type="number" class="form-input" id="gradeInput"
                       min="1" max="6" step="0.5" placeholder="4.5">
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="semestrielCheckbox">
                    <label for="semestrielCheckbox" class="form-label" style="margin: 0;">
                        C'est un Semestriel
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Poids de la note</label>
                <div style="display: flex; gap: 10px;">
                    <label style="flex: 1; cursor: pointer;">
                        <input type="radio" name="gradeWeight" value="1" id="weightSingle" checked style="margin-right: 8px;">
                        Simple (√ó1)
                    </label>
                    <label style="flex: 1; cursor: pointer;">
                        <input type="radio" name="gradeWeight" value="2" id="weightDouble" style="margin-right: 8px;">
                        Double (√ó2)
                    </label>
                </div>
            </div>

            <div id="semesterInfo" style="background: #eff6ff; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; color: #1e40af;">
                <!-- Auto-detected semester info will appear here -->
            </div>

            <div class="button-group">
                <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                <button class="btn btn-primary" onclick="saveGrade()">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Grade Options Modal -->
    <div id="gradeOptionsModal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="gradeOptionsTitle">Note: 4.5</div>

            <div style="display: flex; flex-direction: column; gap: 12px;">
                <button class="btn btn-primary" onclick="modifyGradeFromOptions()" style="background: #3b82f6;">
                    Modifier la Note
                </button>
                <button class="btn btn-secondary" onclick="deleteGradeFromOptions()" style="background: #ef4444; color: white;">
                    Supprimer la Note
                </button>
                <button class="btn btn-secondary" onclick="closeGradeOptionsModal()">
                    Annuler
                </button>
            </div>
        </div>
    </div>

    <script>
        const SUBJECT_WEIGHTS = {
            'Allemand': { regular: 2/3, semestriels: 1/3 },
            'Anglais': { regular: 2/3, semestriels: 1/3 },
            'Biologie': { regular: 2/3, semestriels: 1/3 },
            'Chimie': { regular: 1/2, semestriels: 1/2 },
            'Droit': { regular: 1/2, semestriels: 1/2 },
            'Economie': { regular: 1/2, semestriels: 1/2 },
            'Fran√ßais': { regular: 1/2, semestriels: 1/2 },
            'G√©ographie': { regular: 1/2, semestriels: 1/2 },
            'Histoire': { regular: 1/2, semestriels: 1/2 },
            'Math': { regular: 1/2, semestriels: 1/2 },
            'Physique': { regular: 3/5, semestriels: 2/5 },
            'Histoire de l\'Art': { regular: 1/2, semestriels: 1/2 },
            'Art': { regular: 1/2, semestriels: 1/2 },
            'Gym': { regular: 1/2, semestriels: 1/2 },
            'Informatique': { regular: 1/2, semestriels: 1/2 }
        };

        let gradesData = {
            'Allemand': {
                semester1: { regular: [{grade: 3.0, weight: 1}], semestriel: null },
                semester2: { regular: [], semestriel: null }
            },
            'Anglais': {
                semester1: { regular: [{grade: 4.5, weight: 1}], semestriel: null },
                semester2: { regular: [], semestriel: null }
            },
            'Art': {
                semester1: { regular: [], semestriel: null },
                semester2: { regular: [], semestriel: null }
            },
            'Biologie': {
                semester1: { regular: [{grade: 4.5, weight: 1}, {grade: 5.5, weight: 1}, {grade: 5.0, weight: 1}], semestriel: null },
                semester2: { regular: [], semestriel: null }
            },
            'Chimie': {
                semester1: { regular: [{grade: 2.5, weight: 1}, {grade: 2.5, weight: 1}, {grade: 4.5, weight: 1}], semestriel: null },
                semester2: { regular: [], semestriel: null }
            },
            'Droit': {
                semester1: { regular: [{grade: 4.5, weight: 1}], semestriel: null },
                semester2: { regular: [], semestriel: null }
            },
            'Economie': {
                semester1: { regular: [{grade: 5.0, weight: 1}], semestriel: null },
                semester2: { regular: [], semestriel: null }
            },
            'Fran√ßais': {
                semester1: { regular: [{grade: 3.0, weight: 1}, {grade: 3.5, weight: 1}], semestriel: null },
                semester2: { regular: [], semestriel: null }
            },
            'G√©ographie': {
                semester1: { regular: [{grade: 4.5, weight: 1}], semestriel: null },
                semester2: { regular: [], semestriel: null }
            },
            'Gym': {
                semester1: { regular: [], semestriel: null },
                semester2: { regular: [], semestriel: null }
            },
            'Histoire': {
                semester1: { regular: [], semestriel: null },
                semester2: { regular: [], semestriel: null }
            },
            'Histoire de l\'Art': {
                semester1: { regular: [{grade: 5.0, weight: 1}, {grade: 5.0, weight: 1}], semestriel: null },
                semester2: { regular: [], semestriel: null }
            },
            'Informatique': {
                semester1: { regular: [{grade: 5.0, weight: 1}], semestriel: null },
                semester2: { regular: [], semestriel: null }
            },
            'Math': {
                semester1: { regular: [{grade: 3.5, weight: 1}, {grade: 3.0, weight: 1}], semestriel: null },
                semester2: { regular: [], semestriel: null }
            },
            'Physique': {
                semester1: { regular: [{grade: 4.0, weight: 1}, {grade: 5.0, weight: 1}], semestriel: null },
                semester2: { regular: [], semestriel: null }
            }
        };

        let selectedSubject = null;
        let editingGrade = null; // { subject, semester, index, isSemestriel }
        let currentGradeOptions = null; // { subject, semester, index, isSemestriel, gradeValue }
        let projectedAverages = {};

        function initializeData() {
            try {
                const savedData = localStorage.getItem('sismondiGrades');
                if (savedData) {
                    const loadedData = JSON.parse(savedData);

                    // Check if data needs migration from old format
                    const firstSubject = Object.keys(loadedData)[0];
                    if (firstSubject && loadedData[firstSubject].regular !== undefined) {
                        // Old format detected - migrate to new format
                        console.log('Migrating old data format to two-semester format');
                        const migratedData = {};
                        Object.keys(loadedData).forEach(subject => {
                            migratedData[subject] = {
                                semester1: {
                                    regular: loadedData[subject].regular || [],
                                    semestriel: loadedData[subject].semestriel || null
                                },
                                semester2: {
                                    regular: [],
                                    semestriel: null
                                }
                            };
                        });
                        gradesData = migratedData;
                        saveData(); // Save migrated data
                    } else {
                        // New format - use as is
                        gradesData = loadedData;
                    }

                    // Migrate grades from numbers to objects with weight
                    let needsMigration = false;
                    Object.keys(gradesData).forEach(subject => {
                        ['semester1', 'semester2'].forEach(semester => {
                            if (gradesData[subject][semester].regular.length > 0) {
                                // Check if first grade is a number (old format)
                                if (typeof gradesData[subject][semester].regular[0] === 'number') {
                                    needsMigration = true;
                                    gradesData[subject][semester].regular =
                                        gradesData[subject][semester].regular.map(grade => ({
                                            grade: grade,
                                            weight: 1
                                        }));
                                }
                            }
                        });
                    });

                    if (needsMigration) {
                        console.log('Migrating grades to include weight property');
                        saveData();
                    }
                }
            } catch (e) {
                console.log('localStorage not available, using default data');
            }
        }

        function saveData() {
            try {
                localStorage.setItem('sismondiGrades', JSON.stringify(gradesData));
            } catch (e) {
                console.log('Could not save to localStorage');
            }
        }

        function populateSubjectSelect() {
            const select = document.getElementById('subjectSelect');
            select.innerHTML = '<option value="">-- Choisir --</option>';
            Object.keys(SUBJECT_WEIGHTS).sort().forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                select.appendChild(option);
            });
        }

        // Round to nearest 0.5 (school rounding rules)
        function roundToHalf(num) {
            return Math.round(num * 2) / 2;
        }

        // Get color class based on grade value
        function getGradeColorClass(grade) {
            if (grade >= 5.0) return 'grade-excellent'; // 5.0-6.0: Green
            if (grade >= 4.5) return 'grade-good';      // 4.5-4.9: Blue
            if (grade >= 4.0) return 'grade-sufficient'; // 4.0-4.4: Yellow
            return 'grade-insufficient';                 // < 4.0: Red
        }

        // Calculate average of grades (weighted)
        function calculateAverage(grades) {
            if (!grades || grades.length === 0) return null;

            let totalWeightedGrade = 0;
            let totalWeight = 0;

            grades.forEach(gradeObj => {
                totalWeightedGrade += gradeObj.grade * gradeObj.weight;
                totalWeight += gradeObj.weight;
            });

            const average = totalWeight > 0 ? totalWeightedGrade / totalWeight : null;
            return average !== null ? roundToHalf(average) : null;
        }

        // Calculate semester average for a subject
        function calculateSemesterAverage(subject, semester) {
            const data = gradesData[subject][semester];
            const weights = SUBJECT_WEIGHTS[subject];

            const regularAvg = calculateAverage(data.regular);
            const semestriel = data.semestriel;

            if (regularAvg === null && semestriel === null) return null;
            if (regularAvg === null) return semestriel;
            if (semestriel === null) return regularAvg;

            const semesterAvg = (regularAvg * weights.regular) + (semestriel * weights.semestriels);
            return roundToHalf(semesterAvg);
        }

        // Calculate annual average for a subject
        function calculateAnnualAverage(subject) {
            const s1Avg = calculateSemesterAverage(subject, 'semester1');
            const s2Avg = calculateSemesterAverage(subject, 'semester2');

            // Check if semester 1 semestriel exists
            const s1SemestrielExists = gradesData[subject].semester1.semestriel !== null;

            if (!s1SemestrielExists) {
                // Before S1 semestriel: only S1 counts as if it's the full year
                return s1Avg;
            } else {
                // After S1 semestriel: both semesters count equally
                if (s1Avg === null && s2Avg === null) return null;
                if (s1Avg === null) return s2Avg;
                if (s2Avg === null) return s1Avg;
                const annualAvg = (s1Avg + s2Avg) / 2;
                return roundToHalf(annualAvg);
            }
        }

        function renderGrades() {
            const container = document.getElementById('gradesContainer');
            container.innerHTML = '';

            Object.keys(gradesData).sort().forEach(subject => {
                const data = gradesData[subject];

                const row = document.createElement('div');
                row.className = 'subject-row';

                const subjectNameDiv = document.createElement('div');
                subjectNameDiv.className = 'subject-name';
                subjectNameDiv.textContent = subject;

                const semestersContainer = document.createElement('div');
                semestersContainer.className = 'semesters-container';

                // Semester 1
                const s1Row = document.createElement('div');
                s1Row.className = 'semester-row';

                const s1Label = document.createElement('div');
                s1Label.className = 'semester-label';
                s1Label.textContent = 'S1';

                const s1Grades = document.createElement('div');
                s1Grades.className = 'grades-line';

                // Regular grades S1
                if (data.semester1.regular.length > 0) {
                    data.semester1.regular.forEach((gradeObj, index) => {
                        const badge = document.createElement('span');
                        badge.className = 'grade-badge ' + getGradeColorClass(gradeObj.grade);
                        badge.style.cursor = 'pointer';
                        badge.textContent = gradeObj.grade.toFixed(1) + ' ';

                        const weightIndicator = document.createElement('span');
                        weightIndicator.className = 'grade-weight' + (gradeObj.weight === 2 ? ' double' : '');
                        weightIndicator.textContent = gradeObj.weight;
                        badge.appendChild(weightIndicator);

                        const deleteBtn = document.createElement('span');
                        deleteBtn.className = 'grade-delete';
                        deleteBtn.textContent = '√ó';
                        deleteBtn.onclick = (e) => {
                            e.stopPropagation();
                            showGradeOptions(subject, 1, index, false);
                        };

                        badge.appendChild(deleteBtn);
                        badge.onclick = (e) => {
                            if (!e.target.classList.contains('grade-delete')) {
                                e.stopPropagation();
                                showGradeOptions(subject, 1, index, false);
                            }
                        };
                        s1Grades.appendChild(badge);
                    });
                } else {
                    const emptySpan = document.createElement('span');
                    emptySpan.className = 'empty-grades';
                    emptySpan.textContent = '-';
                    s1Grades.appendChild(emptySpan);
                }

                s1Row.appendChild(s1Label);
                s1Row.appendChild(s1Grades);

                // Semestriel S1 (in separate cell for alignment)
                const s1SemestrielCell = document.createElement('div');
                s1SemestrielCell.className = 'semestriel-cell';

                if (data.semester1.semestriel !== null) {
                    const badge = document.createElement('span');
                    badge.className = 'semestriel-badge';
                    badge.style.cursor = 'pointer';
                    badge.textContent = data.semester1.semestriel.toFixed(1) + ' ';

                    const deleteBtn = document.createElement('span');
                    deleteBtn.className = 'grade-delete';
                    deleteBtn.textContent = '√ó';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        showGradeOptions(subject, 1, 0, true);
                    };

                    badge.appendChild(deleteBtn);
                    badge.onclick = (e) => {
                        if (!e.target.classList.contains('grade-delete')) {
                            e.stopPropagation();
                            showGradeOptions(subject, 1, 0, true);
                        }
                    };
                    s1SemestrielCell.appendChild(badge);
                } else {
                    const emptySpan = document.createElement('span');
                    emptySpan.className = 'semestriel-empty';
                    emptySpan.textContent = 'Sem -';
                    s1SemestrielCell.appendChild(emptySpan);
                }

                s1Row.appendChild(s1SemestrielCell);

                // Semester 2
                const s2Row = document.createElement('div');
                s2Row.className = 'semester-row';

                const s2Label = document.createElement('div');
                s2Label.className = 'semester-label';
                s2Label.textContent = 'S2';

                const s2Grades = document.createElement('div');
                s2Grades.className = 'grades-line';

                // Regular grades S2
                if (data.semester2.regular.length > 0) {
                    data.semester2.regular.forEach((gradeObj, index) => {
                        const badge = document.createElement('span');
                        badge.className = 'grade-badge ' + getGradeColorClass(gradeObj.grade);
                        badge.style.cursor = 'pointer';
                        badge.textContent = gradeObj.grade.toFixed(1) + ' ';

                        const weightIndicator = document.createElement('span');
                        weightIndicator.className = 'grade-weight' + (gradeObj.weight === 2 ? ' double' : '');
                        weightIndicator.textContent = gradeObj.weight;
                        badge.appendChild(weightIndicator);

                        const deleteBtn = document.createElement('span');
                        deleteBtn.className = 'grade-delete';
                        deleteBtn.textContent = '√ó';
                        deleteBtn.onclick = (e) => {
                            e.stopPropagation();
                            showGradeOptions(subject, 2, index, false);
                        };

                        badge.appendChild(deleteBtn);
                        badge.onclick = (e) => {
                            if (!e.target.classList.contains('grade-delete')) {
                                e.stopPropagation();
                                showGradeOptions(subject, 2, index, false);
                            }
                        };
                        s2Grades.appendChild(badge);
                    });
                } else {
                    const emptySpan = document.createElement('span');
                    emptySpan.className = 'empty-grades';
                    emptySpan.textContent = '-';
                    s2Grades.appendChild(emptySpan);
                }

                s2Row.appendChild(s2Label);
                s2Row.appendChild(s2Grades);

                // Semestriel S2 (in separate cell for alignment)
                const s2SemestrielCell = document.createElement('div');
                s2SemestrielCell.className = 'semestriel-cell';

                if (data.semester2.semestriel !== null) {
                    const badge = document.createElement('span');
                    badge.className = 'semestriel-badge';
                    badge.style.cursor = 'pointer';
                    badge.textContent = data.semester2.semestriel.toFixed(1) + ' ';

                    const deleteBtn = document.createElement('span');
                    deleteBtn.className = 'grade-delete';
                    deleteBtn.textContent = '√ó';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        showGradeOptions(subject, 2, 0, true);
                    };

                    badge.appendChild(deleteBtn);
                    badge.onclick = (e) => {
                        if (!e.target.classList.contains('grade-delete')) {
                            e.stopPropagation();
                            showGradeOptions(subject, 2, 0, true);
                        }
                    };
                    s2SemestrielCell.appendChild(badge);
                } else {
                    const emptySpan = document.createElement('span');
                    emptySpan.className = 'semestriel-empty';
                    emptySpan.textContent = 'Sem -';
                    s2SemestrielCell.appendChild(emptySpan);
                }

                s2Row.appendChild(s2SemestrielCell);

                semestersContainer.appendChild(s1Row);
                semestersContainer.appendChild(s2Row);

                row.appendChild(subjectNameDiv);
                row.appendChild(semestersContainer);

                row.onclick = (e) => {
                    if (!e.target.classList.contains('grade-delete')) {
                        openSubjectModal(subject);
                    }
                };

                container.appendChild(row);
            });
        }

        function updateSemesterInfo(subject) {
            if (!subject || !gradesData[subject]) {
                document.getElementById('semesterInfo').innerHTML = '';
                return;
            }

            const s1Sem = gradesData[subject].semester1.semestriel;
            const s2Sem = gradesData[subject].semester2.semestriel;
            const isSemestriel = document.getElementById('semestrielCheckbox').checked;

            let message = '';
            let canAdd = true;

            if (isSemestriel) {
                if (s1Sem === null) {
                    message = 'üìù Ajout au <strong>Semestre 1</strong>';
                } else if (s2Sem === null) {
                    message = 'üìù Ajout au <strong>Semestre 2</strong>';
                } else {
                    message = '‚ö†Ô∏è <strong>Les 2 semestriels sont d√©j√† entr√©s</strong>';
                    canAdd = false;
                }
            } else {
                if (s1Sem === null) {
                    message = 'üìù Ajout au <strong>Semestre 1</strong> (notes r√©guli√®res)';
                } else {
                    message = 'üìù Ajout au <strong>Semestre 2</strong> (notes r√©guli√®res)';
                }
            }

            document.getElementById('semesterInfo').innerHTML = message;
            document.querySelector('.btn-primary').disabled = !canAdd;
        }

        function openAddGradeModal() {
            selectedSubject = null;
            document.getElementById('modalTitle').textContent = 'Ajouter une Note';
            document.getElementById('subjectSelect').disabled = false;
            document.getElementById('subjectSelect').value = '';
            document.getElementById('gradeInput').value = '';
            document.getElementById('semestrielCheckbox').checked = false;
            document.getElementById('weightSingle').checked = true;
            document.getElementById('semesterInfo').innerHTML = '';
            document.getElementById('addGradeModal').classList.add('active');

            // Add listeners for updates
            document.getElementById('subjectSelect').onchange = () => {
                updateSemesterInfo(document.getElementById('subjectSelect').value);
            };
            document.getElementById('semestrielCheckbox').onchange = () => {
                updateSemesterInfo(selectedSubject || document.getElementById('subjectSelect').value);
            };
        }

        function openSubjectModal(subject) {
            selectedSubject = subject;
            document.getElementById('modalTitle').textContent = `Ajouter une Note - ${subject}`;
            document.getElementById('subjectSelect').value = subject;
            document.getElementById('subjectSelect').disabled = true;
            document.getElementById('gradeInput').value = '';
            document.getElementById('semestrielCheckbox').checked = false;
            document.getElementById('weightSingle').checked = true;
            document.getElementById('addGradeModal').classList.add('active');

            updateSemesterInfo(subject);

            // Add listener for checkbox updates
            document.getElementById('semestrielCheckbox').onchange = () => {
                updateSemesterInfo(subject);
            };
        }

        function closeModal() {
            document.getElementById('addGradeModal').classList.remove('active');
            document.getElementById('semestrielCheckbox').disabled = false;
            document.querySelector('.btn-primary').textContent = 'Ajouter';
            selectedSubject = null;
            editingGrade = null;
        }

        function saveGrade() {
            const subject = selectedSubject || document.getElementById('subjectSelect').value;
            const gradeValue = parseFloat(document.getElementById('gradeInput').value);
            const isSemestriel = document.getElementById('semestrielCheckbox').checked;
            const weight = parseInt(document.querySelector('input[name="gradeWeight"]:checked').value);

            if (!subject) {
                alert('Veuillez choisir une mati√®re');
                return;
            }

            if (isNaN(gradeValue) || gradeValue < 1 || gradeValue > 6) {
                alert('Veuillez entrer une note entre 1.0 et 6.0');
                return;
            }

            if (!gradesData[subject]) {
                gradesData[subject] = {
                    semester1: { regular: [], semestriel: null },
                    semester2: { regular: [], semestriel: null }
                };
            }

            // Check if we're editing an existing grade
            if (editingGrade) {
                const semesterKey = 'semester' + editingGrade.semester;

                if (editingGrade.isSemestriel) {
                    gradesData[editingGrade.subject][semesterKey].semestriel = gradeValue;
                } else {
                    gradesData[editingGrade.subject][semesterKey].regular[editingGrade.index] = {
                        grade: gradeValue,
                        weight: weight
                    };
                }

                editingGrade = null;
            } else {
                // AUTO-DETECT which semester to add to
                let semester = 1;
                const s1Sem = gradesData[subject].semester1.semestriel;
                const s2Sem = gradesData[subject].semester2.semestriel;

                if (isSemestriel) {
                    // For semestriel grades
                    if (s1Sem === null) {
                        semester = 1;
                    } else if (s2Sem === null) {
                        semester = 2;
                    } else {
                        alert('Les 2 semestriels sont d√©j√† entr√©s pour cette mati√®re');
                        return;
                    }
                } else {
                    // For regular grades
                    if (s1Sem === null) {
                        semester = 1; // Before S1 semestriel, add to S1
                    } else {
                        semester = 2; // After S1 semestriel, add to S2
                    }
                }

                const semesterKey = 'semester' + semester;

                if (isSemestriel) {
                    gradesData[subject][semesterKey].semestriel = gradeValue;
                } else {
                    gradesData[subject][semesterKey].regular.push({
                        grade: gradeValue,
                        weight: weight
                    });
                }
            }

            saveData();
            renderGrades();
            closeModal();
        }

        function showGradeOptions(subject, semester, index, isSemestriel) {
            const semesterKey = 'semester' + semester;
            let gradeValue, weight;

            if (isSemestriel) {
                gradeValue = gradesData[subject][semesterKey].semestriel;
                weight = 1;
            } else {
                const gradeObj = gradesData[subject][semesterKey].regular[index];
                gradeValue = gradeObj.grade;
                weight = gradeObj.weight;
            }

            // Store current grade info
            currentGradeOptions = { subject, semester, index, isSemestriel, gradeValue };

            // Update modal title
            document.getElementById('gradeOptionsTitle').textContent = `Note: ${gradeValue.toFixed(1)}`;

            // Show modal
            document.getElementById('gradeOptionsModal').classList.add('active');
        }

        function closeGradeOptionsModal() {
            document.getElementById('gradeOptionsModal').classList.remove('active');
            currentGradeOptions = null;
        }

        function modifyGradeFromOptions() {
            if (!currentGradeOptions) return;

            closeGradeOptionsModal();
            editGrade(
                currentGradeOptions.subject,
                currentGradeOptions.semester,
                currentGradeOptions.index,
                currentGradeOptions.isSemestriel
            );
        }

        function deleteGradeFromOptions() {
            if (!currentGradeOptions) return;

            closeGradeOptionsModal();
            deleteGrade(
                currentGradeOptions.subject,
                currentGradeOptions.semester,
                currentGradeOptions.index,
                currentGradeOptions.isSemestriel
            );
        }

        function editGrade(subject, semester, index, isSemestriel) {
            editingGrade = { subject, semester, index, isSemestriel };

            const semesterKey = 'semester' + semester;
            let gradeValue, weight;

            if (isSemestriel) {
                gradeValue = gradesData[subject][semesterKey].semestriel;
                weight = 1;
            } else {
                const gradeObj = gradesData[subject][semesterKey].regular[index];
                gradeValue = gradeObj.grade;
                weight = gradeObj.weight;
            }

            document.getElementById('modalTitle').textContent = `Modifier la Note - ${subject}`;
            document.getElementById('subjectSelect').value = subject;
            document.getElementById('subjectSelect').disabled = true;
            document.getElementById('gradeInput').value = gradeValue;
            document.getElementById('semestrielCheckbox').checked = isSemestriel;
            document.getElementById('semestrielCheckbox').disabled = true;

            if (weight === 2) {
                document.getElementById('weightDouble').checked = true;
            } else {
                document.getElementById('weightSingle').checked = true;
            }

            document.getElementById('semesterInfo').innerHTML = '<strong>Modification de la note</strong>';
            document.querySelector('.btn-primary').textContent = 'Modifier';
            document.getElementById('addGradeModal').classList.add('active');
        }

        function deleteGrade(subject, semester, index, isSemestriel) {
            if (!confirm('Supprimer cette note?')) return;

            const semesterKey = 'semester' + semester;

            if (isSemestriel) {
                gradesData[subject][semesterKey].semestriel = null;
            } else {
                gradesData[subject][semesterKey].regular.splice(index, 1);
            }

            saveData();
            renderGrades();
        }

        // Projections functionality
        function switchTab(tabName) {
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            if (tabName === 'grades') {
                document.getElementById('gradesTab').classList.add('active');
            } else if (tabName === 'projections') {
                document.getElementById('projectionsTab').classList.add('active');
                initializeProjections();
            } else if (tabName === 'rules') {
                document.getElementById('rulesTab').classList.add('active');
            }
        }

        function initializeProjections() {
            projectedAverages = {};
            Object.keys(gradesData).forEach(subject => {
                const annualAvg = calculateAnnualAverage(subject);
                projectedAverages[subject] = annualAvg !== null ? annualAvg : 4.0;
            });

            renderSliders();
            updateProjectionMetrics();
        }

        function renderSliders() {
            const container = document.getElementById('slidersContainer');
            container.innerHTML = '';

            Object.keys(gradesData).sort().forEach(subject => {
                const currentAvg = calculateAnnualAverage(subject) || 4.0;
                const value = projectedAverages[subject] || currentAvg;

                const row = document.createElement('div');
                row.className = 'slider-row';

                const header = document.createElement('div');
                header.className = 'slider-header';

                const subjectName = document.createElement('div');
                subjectName.className = 'slider-subject';
                subjectName.textContent = subject;

                const valueDisplay = document.createElement('div');
                valueDisplay.className = 'slider-value';
                valueDisplay.id = 'slider-value-' + subject.replace(/[^a-zA-Z0-9]/g, '_');
                valueDisplay.textContent = value.toFixed(1);
                updateValueColor(valueDisplay, value);

                header.appendChild(subjectName);
                header.appendChild(valueDisplay);

                const sliderContainer = document.createElement('div');
                sliderContainer.className = 'slider-container';

                const fill = document.createElement('div');
                fill.className = 'slider-fill';
                fill.id = 'slider-fill-' + subject.replace(/[^a-zA-Z0-9]/g, '_');
                fill.style.width = (((value - 1.0) / 5.0) * 100) + '%';
                updateFillColor(fill, value);

                const targetLineTop = document.createElement('div');
                targetLineTop.className = 'slider-target-line slider-target-line-top';

                const targetLineBottom = document.createElement('div');
                targetLineBottom.className = 'slider-target-line slider-target-line-bottom';

                const middleMarker = document.createElement('div');
                middleMarker.className = 'slider-middle-marker';
                middleMarker.textContent = '4.0';

                const currentMarker = document.createElement('div');
                currentMarker.className = 'slider-current-marker';
                currentMarker.style.left = (((currentAvg - 1.0) / 5.0) * 100) + '%';

                const markers = document.createElement('div');
                markers.className = 'slider-markers';
                markers.innerHTML = '<span class="slider-marker">1.0</span><span class="slider-marker" style="opacity:0;">4.0</span><span class="slider-marker">6.0</span>';

                const input = document.createElement('input');
                input.type = 'range';
                input.min = '1.0';
                input.max = '6.0';
                input.step = '0.1';
                input.value = value;
                input.className = 'slider-input';

                input.addEventListener('input', (e) => {
                    const newValue = parseFloat(e.target.value);
                    projectedAverages[subject] = newValue;

                    valueDisplay.textContent = newValue.toFixed(1);
                    updateValueColor(valueDisplay, newValue);

                    fill.style.width = (((newValue - 1.0) / 5.0) * 100) + '%';
                    updateFillColor(fill, newValue);

                    updateProjectionMetrics();
                });

                sliderContainer.appendChild(fill);
                sliderContainer.appendChild(targetLineTop);
                sliderContainer.appendChild(targetLineBottom);
                sliderContainer.appendChild(middleMarker);
                sliderContainer.appendChild(currentMarker);
                sliderContainer.appendChild(markers);
                sliderContainer.appendChild(input);

                row.appendChild(header);
                row.appendChild(sliderContainer);
                container.appendChild(row);
            });
        }

        function updateValueColor(element, value) {
            element.className = 'slider-value';
            if (value >= 4.0) {
                element.classList.add('good');
            } else if (value >= 3.5) {
                element.classList.add('warning');
            } else {
                element.classList.add('danger');
            }
        }

        function updateFillColor(element, value) {
            element.className = 'slider-fill';
            if (value >= 4.0) {
                // Keep good color (default)
            } else if (value >= 3.5) {
                element.classList.add('warning');
            } else {
                element.classList.add('danger');
            }
        }

        function updateProjectionMetrics() {
            const averages = projectedAverages;

            const validAverages = Object.values(averages).filter(avg => avg !== null && avg !== undefined);
            const generalAvg = validAverages.length > 0
                ? roundToHalf(validAverages.reduce((a, b) => a + b, 0) / validAverages.length)
                : 0;

            const ecoAvg = averages['Economie'];
            const droitAvg = averages['Droit'];
            const optionSpecifique = (ecoAvg && droitAvg)
                ? roundToHalf((ecoAvg + droitAvg) / 2)
                : (ecoAvg || droitAvg || 0);

            const frAvg = averages['Fran√ßais'] || 0;
            const deAvg = averages['Allemand'] || 0;
            const enAvg = averages['Anglais'] || 0;
            const mathAvg = averages['Math'] || 0;

            const langAvg = roundToHalf((deAvg + enAvg) / 2);
            const criticalTotal = roundToHalf(frAvg + langAvg + mathAvg + optionSpecifique);

            const insufficient = [];
            Object.keys(averages).forEach(subject => {
                const avg = averages[subject];
                if (avg !== null && avg !== undefined && avg < 4.0) {
                    insufficient.push({ subject, grade: avg, deficit: 4.0 - avg });
                }
            });

            const totalDeficit = insufficient.reduce((sum, item) => sum + item.deficit, 0);

            updateMetricDisplay('projAvg', generalAvg, 4.0);
            updateMetricDisplay('projOS', optionSpecifique, 4.0);
            updateMetricDisplay('projCrit', criticalTotal, 16.0);

            const insuffElem = document.getElementById('projInsuff');
            insuffElem.textContent = insufficient.length + ' (' + totalDeficit.toFixed(1) + ')';
            insuffElem.className = 'metric-value';
            if (insufficient.length === 0) {
                insuffElem.classList.add('good');
            } else if (insufficient.length <= 3 && totalDeficit <= 1.0) {
                insuffElem.classList.add('warning');
            } else {
                insuffElem.classList.add('danger');
            }

            let status = '';
            let statusClass = '';

            if (insufficient.length === 0) {
                status = 'Promotion Directe';
                statusClass = 'pass';
            } else {
                const conditions = {
                    generalAvg: generalAvg >= 4.0,
                    optionSpec: optionSpecifique >= 4.0,
                    insuffCount: insufficient.length <= 3,
                    deficitOk: totalDeficit <= 1.0,
                    criticalOk: criticalTotal >= 16.0
                };

                if (conditions.generalAvg && conditions.optionSpec &&
                    conditions.insuffCount && conditions.deficitOk && conditions.criticalOk) {
                    status = 'Promotion par Tol√©rance';
                    statusClass = 'tolerance';
                } else {
                    status = '‚ùå Risque de Non-Promotion';
                    statusClass = 'fail';
                }
            }

            const statusBanner = document.getElementById('statusBanner');
            statusBanner.textContent = status;
            statusBanner.className = 'status-banner ' + statusClass;
        }

        function updateMetricDisplay(elementId, value, threshold) {
            const elem = document.getElementById(elementId);
            const roundedValue = roundToHalf(value);
            elem.textContent = roundedValue.toFixed(1);
            elem.className = 'metric-value';

            if (roundedValue >= threshold) {
                elem.classList.add('good');
            } else if (roundedValue >= threshold - 0.5) {
                elem.classList.add('warning');
            } else {
                elem.classList.add('danger');
            }
        }

        document.getElementById('addGradeModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        document.getElementById('gradeOptionsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeGradeOptionsModal();
            }
        });

        try {
            initializeData();
            populateSubjectSelect();
            renderGrades();
            console.log('App initialized successfully');
        } catch (error) {
            console.error('Error initializing app:', error);
            document.getElementById('gradesContainer').innerHTML =
                '<div style="color: white; padding: 20px; background: #ef4444; border-radius: 10px; margin: 20px;">ERROR: ' + error.message + '</div>';
        }
    </script>
</body>
</html>
